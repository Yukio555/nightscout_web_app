<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nightscoutæ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Arial', 'Helvetica', 'Meiryo', sans-serif;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 15px;
        }
        .date-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        .date-selector input {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
        }
        .date-selector button {
            padding: 10px 20px;
            background-color: white;
            color: #667eea;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .date-selector button:hover {
            background-color: #f0f0f0;
            transform: translateY(-2px);
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
            display: none;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            min-height: calc(100vh - 180px);
        }
        .graph-section {
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 20px;
            background-color: white;
            border-bottom: 2px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .chart-wrapper {
            height: 200px;
            margin-bottom: 10px;
        }
        .table-section {
            padding: 0 20px 20px 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        thead {
            position: sticky;
            top: 242px;
            z-index: 50;
        }
        th {
            background-color: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        td {
            padding: 10px 8px;
            border: 1px solid #ddd;
            background-color: white;
        }
        tr:nth-child(even) td {
            background-color: #f9f9f9;
        }
        tr:hover td {
            background-color: #fffacd;
            cursor: pointer;
        }
        .stats-section {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .stat-box {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .stat-value {
            font-size: 28px;
            color: #333;
            font-weight: bold;
        }
        .stat-unit {
            font-size: 16px;
            color: #888;
            margin-left: 3px;
        }
        .footer {
            text-align: center;
            color: #666;
            font-size: 12px;
            padding: 20px;
        }
        @media print {
            .header { position: relative; }
            .graph-section { position: relative; top: auto; box-shadow: none; }
            thead { position: relative; top: auto; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“Š Nightscoutæ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</h1>
        <div class="date-selector">
            <input type="date" id="dateInput" value="{{ today }}">
            <button onclick="loadReport()">ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º</button>
        </div>
    </div>
    
    <div class="loading" id="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
    
    <div class="container" id="reportContainer" style="display: none;">
        <div class="graph-section">
            <div class="chart-wrapper">
                <canvas id="bgChart"></canvas>
            </div>
        </div>
        
        <div class="table-section">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>æ™‚åˆ»</th>
                        <th>è¡€ç³–å€¤</th>
                        <th>CIR</th>
                        <th>ç³–è³ª</th>
                        <th>äºˆæƒ³</th>
                        <th>æ‰“ã£ãŸ</th>
                        <th>ç¨®é¡</th>
                        <th>é£Ÿã¹ãŸã‚‚ã®</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
        
        <div class="stats-section">
            <div class="stat-box">
                <div class="stat-label">å¹³å‡è¡€ç³–å€¤</div>
                <div class="stat-value"><span id="avgBg">-</span><span class="stat-unit">mg/dL</span></div>
            </div>
            <div class="stat-box">
                <div class="stat-label">ã‚¤ãƒ³ã‚¹ãƒªãƒ³ç·é‡</div>
                <div class="stat-value"><span id="totalInsulin">-</span><span class="stat-unit">å˜ä½</span></div>
                <div style="font-size: 11px; color: #999; margin-top: 5px;">(åŸºç¤é™¤ã)</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">åŸºç¤ã‚¤ãƒ³ã‚¹ãƒªãƒ³</div>
                <div class="stat-value"><span id="basalInsulin">-</span><span class="stat-unit">å˜ä½</span></div>
            </div>
            <div class="stat-box">
                <div class="stat-label">ç³–è³ªç·é‡</div>
                <div class="stat-value"><span id="totalCarbs">-</span><span class="stat-unit">g</span></div>
            </div>
            <div class="stat-box">
                <div class="stat-label">TCIR</div>
                <div class="stat-value" id="tcir">-</div>
            </div>
        </div>
        
        <div class="footer">
            <p>Generated from Nightscout: {{ nightscout_url }}</p>
        </div>
    </div>
    
    <script>
        let bgChart = null;
        
        async function loadReport() {
            const dateInput = document.getElementById('dateInput');
            const date = dateInput.value;
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('reportContainer').style.display = 'none';
            
            try {
                const response = await fetch(`/api/report?date=${date}`);
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯ã‚µãƒ¼ãƒãƒ¼å´ (app.py) ã«å‡ºåŠ›ã•ã‚Œã¾ã™
                    return;
                }
                
                // ã‚°ãƒ©ãƒ•æç”»
                drawChart(data);
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
                drawTable(data.table_data);
                
                // çµ±è¨ˆè¡¨ç¤º
                document.getElementById('avgBg').textContent = data.avg_bg;
                document.getElementById('totalInsulin').textContent = data.total_insulin;
                document.getElementById('basalInsulin').textContent = data.basal_insulin;
                document.getElementById('totalCarbs').textContent = data.total_carbs;
                document.getElementById('tcir').textContent = data.tcir;
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('reportContainer').style.display = 'block';
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»å¾Œã«ãƒ›ãƒãƒ¼æ©Ÿèƒ½ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
                setTimeout(() => {
                    setupTableHover(data);
                }, 100);
            } catch (error) {
                alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„: ' + error);
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function drawChart(data) {
            const ctx = document.getElementById('bgChart').getContext('2d');
            
            if (bgChart) {
                bgChart.destroy();
            }
            
            bgChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.chart_times,
                    datasets: [{
                        label: 'è¡€ç³–å€¤',
                        data: data.chart_bgs,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'ç›®æ¨™ç¯„å›²ä¸‹é™',
                        data: Array(data.chart_times.length).fill(70),
                        borderColor: '#4CAF50',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    },
                    {
                        label: 'ç›®æ¨™ç¯„å›²ä¸Šé™',
                        data: Array(data.chart_times.length).fill(180),
                        borderColor: '#4CAF50',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: '-1',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'è¡€ç³–å€¤æ¨ç§»',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 0,
                            max: 400,
                            title: {
                                display: true,
                                text: 'è¡€ç³–å€¤ (mg/dL)',
                                font: { weight: 'bold' }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 0,
                                minRotation: 0,
                                autoSkip: false,
                                font: {
                                    size: 12
                                },
                                callback: function(value, index, values) {
                                    const label = this.getLabelForValue(value);
                                    if (!label) return '';
                                    
                                    // HH:MMå½¢å¼ã‹ã‚‰æ™‚é–“éƒ¨åˆ†ã‚’æŠ½å‡º
                                    const timeParts = label.split(':');
                                    const hour = parseInt(timeParts[0]);
                                    
                                    // 1æ™‚é–“ãŠãã«è¡¨ç¤ºã€ã¾ãŸã¯æœ€åˆã®ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤º
                                    // ãƒ‡ãƒ¼ã‚¿ã®å¯†åº¦ãŒé«˜ã„å ´åˆã€Chart.jsãŒè‡ªå‹•ã§ãƒ©ãƒ™ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚
                                    if (timeParts[1] === '00' || index === 0) {
                                        return hour + 'æ™‚';
                                    }
                                    
                                    // å‰å¾Œã®ãƒ©ãƒ™ãƒ«ã¨ã®é–“éš”ãŒè¿‘ã™ãã‚‹å ´åˆã‚‚ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ãŒã€ã“ã“ã§ã¯00åˆ†ä»¥å¤–ã¯åŸºæœ¬çš„ã«éè¡¨ç¤º
                                    return '';
                                }
                            },
                            title: {
                                display: true,
                                text: 'æ™‚åˆ»',
                                font: { weight: 'bold' }
                            }
                        }
                    }
                }
            });
        }
        
        function drawTable(tableData) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            tableData.forEach(row => {
                const tr = document.createElement('tr');
                // ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãŒå³å¯†ã«ãªã£ãŸãŸã‚ã€chart_timesã«å­˜åœ¨ã™ã‚‹æ™‚åˆ»ã§ç´ä»˜ã‘ã¾ã™
                tr.dataset.time = row.time; 
                tr.innerHTML = `
                    <td>${row.time}</td>
                    <td>${row.bg}</td>
                    <td>${row.cir}</td>
                    <td>${row.carbs}</td>
                    <td>${row.predicted}</td>
                    <td>${row.actual}</td>
                    <td>${row.type}</td>
                    <td>${row.food}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function setupTableHover(data) {
            const tableRows = document.querySelectorAll('#dataTable tbody tr');
            
            tableRows.forEach((row) => {
                let highlightDataset = null;
                
                row.addEventListener('mouseenter', function() {
                    const time = this.dataset.time;
                    
                    if (!time || !bgChart) return;
                    
                    let index = -1;
                    const targetTime = time.split(':').map(Number); // [H, M]
                    const targetMinutes = targetTime[0] * 60 + targetTime[1];
                    let minDiff = Infinity;
                    
                    // æœ€ã‚‚è¿‘ã„CGMãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã‚’æ¢ã™
                    data.chart_times.forEach((label, i) => {
                        const labelTime = label.split(':').map(Number); // [H, M]
                        const labelMinutes = labelTime[0] * 60 + labelTime[1];
                        const diff = Math.abs(targetMinutes - labelMinutes);
                        
                        if (diff < minDiff) {
                            minDiff = diff;
                            index = i;
                        }
                    });
                    
                    // é©åˆ‡ãªãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°å‡¦ç†ã‚’çµ‚äº†
                    if (index === -1 || !data.chart_bgs[index] || minDiff > 15) return; // 15åˆ†ä»¥ä¸Šé›¢ã‚Œã¦ã„ãŸã‚‰ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ãªã„
                    
                    // æ—¢å­˜ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤
                    bgChart.data.datasets = bgChart.data.datasets.filter(ds => ds.label !== 'ãƒã‚¤ãƒ©ã‚¤ãƒˆ' && ds.label !== 'ãƒã‚¤ãƒ©ã‚¤ãƒˆç·š');
                    
                    // ãƒã‚¤ãƒ³ãƒˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆå¤§ããªæ˜Ÿãƒãƒ¼ã‚¯ï¼‰
                    const highlightData = Array(data.chart_times.length).fill(null);
                    highlightData[index] = data.chart_bgs[index];
                    
                    highlightDataset = {
                        label: 'ãƒã‚¤ãƒ©ã‚¤ãƒˆ',
                        data: highlightData,
                        borderColor: '#FF6B35',
                        backgroundColor: '#FF6B35',
                        pointRadius: 15,
                        pointHoverRadius: 18,
                        showLine: false,
                        pointStyle: 'star',
                        borderWidth: 3,
                        order: 0 // æœ€å‰é¢ã«è¡¨ç¤º
                    };
                    
                    // å‚ç›´ç·šã‚’è¿½åŠ ï¼ˆæ³¨ç›®ãƒã‚¤ãƒ³ãƒˆã‚’å¼·èª¿ï¼‰
                    const lineData = Array(data.chart_times.length).fill(null);
                    lineData[index] = data.chart_bgs[index];
                    
                    const verticalLine = {
                        label: 'ãƒã‚¤ãƒ©ã‚¤ãƒˆç·š',
                        data: lineData,
                        borderColor: 'rgba(255, 107, 53, 0.3)',
                        backgroundColor: 'rgba(255, 107, 53, 0.2)',
                        pointRadius: 0,
                        showLine: true,
                        borderWidth: 4,
                        borderDash: [10, 5],
                        fill: false,
                        order: 1 // ä¸»ç·šã‚ˆã‚Šå‰ã«è¡¨ç¤º
                    };
                    
                    bgChart.data.datasets.push(highlightDataset);
                    bgChart.data.datasets.push(verticalLine);
                    bgChart.update('none');
                });
                
                row.addEventListener('mouseleave', function() {
                    if (bgChart) {
                        // ãƒã‚¤ãƒ©ã‚¤ãƒˆè¦ç´ ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦å‰Šé™¤
                        bgChart.data.datasets = bgChart.data.datasets.filter(ds => ds.label !== 'ãƒã‚¤ãƒ©ã‚¤ãƒˆ' && ds.label !== 'ãƒã‚¤ãƒ©ã‚¤ãƒˆç·š');
                        bgChart.update('none');
                    }
                });
            });
        }
        
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ¬ãƒãƒ¼ãƒˆã‚’è‡ªå‹•ã§èª­ã¿è¾¼ã‚€
        document.addEventListener('DOMContentLoaded', loadReport);
        
    </script>
</body>
</html>